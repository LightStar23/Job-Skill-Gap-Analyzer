{% extends "base.html" %}

{% block title %}Analysis Details - {{ analysis.job_title }}{% endblock %}

{% block content %}
<div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary" style="padding: 10px 15px;">
        <i class="fas fa-arrow-left"></i>
    </a>
    <div>
        <h1 style="margin-bottom: 0.25rem;">ðŸ“Š Analysis Details</h1>
        <p style="color: var(--text-secondary);">Detailed breakdown of your skill match analysis</p>
    </div>
</div>

<!-- Add this section to show gap bridge -->
{% if results.gap_bridge_plans %}
<div style="background: #e8f5e9; padding: 20px; margin: 20px 0; border-radius: 8px;">
    <h2>ðŸš€ Personalized Learning Plans</h2>

    {% if results.gap_summary %}
    <div style="background: white; padding: 15px; border-radius: 5px; margin: 15px 0;">
        <h3>ðŸ“Š Learning Summary</h3>
        <p><strong>Skills to Learn:</strong> {{ results.gap_summary.total_skills }}</p>
        <p><strong>Total Time:</strong> {{ results.gap_summary.total_hours }} hours</p>
        <p><strong>Weekly Commitment:</strong> {{ results.gap_summary.weekly_commitment }} hours/week</p>
        <p><strong>Estimated Completion:</strong> {{ results.gap_summary.total_weeks }} weeks</p>
    </div>
    {% endif %}

    {% for plan in results.gap_bridge_plans %}
    <div style="background: white; padding: 15px; margin: 15px 0; border-radius: 5px; border-left: 4px solid #2196F3;">
        <h3>{{ plan.skill }} - {{ plan.time_required }} hours ({{ plan.weeks_needed }} weeks)</h3>

        <div style="display: flex; gap: 20px; margin-top: 10px;">
            <div style="flex: 1;">
                <h4>ðŸ“š Resources:</h4>
                {% for resource in plan.resources %}
                <div style="margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px;">
                    <strong>{{ resource.name }}</strong>
                    {% if resource.url %}
                    <br><a href="{{ resource.url }}" target="_blank">Visit â†’</a>
                    {% endif %}
                    {% if resource.duration_hours %}
                    <br><small>Duration: {{ resource.duration_hours }} hours</small>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <div style="flex: 1;">
                <h4>ðŸ’» Projects:</h4>
                {% for project in plan.projects %}
                <div style="margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px;">
                    <strong>{{ project.title }}</strong>
                    {% if project.description %}
                    <br><small>{{ project.description }}</small>
                    {% endif %}
                    {% if project.estimated_time %}
                    <br><small>Time: ~{{ project.estimated_time }} hours</small>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}


<div class="card fade-in">
    <div class="analysis-header"
        style="border-bottom: 1px solid var(--border-color); padding-bottom: 1.5rem; margin-bottom: 2rem;">
        <h2 style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-briefcase"></i> {{ analysis.job_title }}
        </h2>
        {% if analysis.company %}
        <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">
            <i class="fas fa-building"></i> {{ analysis.company }}
        </p>
        {% endif %}
        <p style="color: var(--text-muted); font-size: 0.9rem;">
            <i class="fas fa-calendar"></i> Analyzed on {{ analysis.created_at.strftime('%B %d, %Y at %H:%M') }}
        </p>
    </div>

    <div style="text-align: center; margin: 3rem 0;">
        <div class="score-circle" style="--score-percent: {{ results.match_score }}%">
            <div class="score-text">{{ "%.1f"|format(results.match_score) }}%</div>
        </div>
        <h3 style="margin-bottom: 0.5rem;">Overall Match Score</h3>
        <p style="color: var(--text-secondary); font-size: 1.1rem;">{{ results.match_interpretation }}</p>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 3rem 0;">
        <div class="card" style="background: var(--success-bg); border-color: var(--success-border);">
            <h4 style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; color: #10b981;">
                <i class="fas fa-check-circle"></i> Matching Skills
                <span
                    style="background: #10b981; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">
                    {{ results.matching_skills|length }}
                </span>
            </h4>
            <div class="skills-list">
                {% for skill in results.matching_skills %}
                <span class="skill-item matching">{{ skill }}</span>
                {% endfor %}
                {% if not results.matching_skills %}
                <p style="color: var(--text-muted); text-align: center; padding: 1rem;">No matching skills found</p>
                {% endif %}
            </div>
        </div>

        <div class="card" style="background: var(--error-bg); border-color: var(--error-border);">
            <h4 style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; color: #ef4444;">
                <i class="fas fa-exclamation-triangle"></i> Skills to Develop
                <span
                    style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">
                    {{ results.missing_skills|length }}
                </span>
            </h4>
            <div class="categorized-gaps">
                {% if results.categorized_gaps %}
                {% for category, skills in results.categorized_gaps.items() %}
                <div style="margin-bottom: 1rem;">
                    <h5
                        style="color: var(--text-secondary); margin-bottom: 0.5rem; text-transform: capitalize; font-size: 0.9rem;">
                        {{ category.replace('_', ' ') }}
                    </h5>
                    <div>
                        {% for skill in skills %}
                        <span class="skill-item missing">{{ skill }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p style="color: var(--text-muted); text-align: center; padding: 1rem;">No significant skill gaps found!
                    Excellent!</p>
                {% endif %}
            </div>
        </div>
    </div>

    {% if results.jd_skills or results.resume_skills %}
    <div style="margin-top: 3rem;">
        <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-list-alt"></i> Detailed Breakdown
        </h3>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div class="card" style="background: var(--bg-secondary);">
                <h4 style="margin-bottom: 1rem; color: var(--text-primary);">
                    <i class="fas fa-file-alt"></i> Job Description Skills
                </h4>
                <div style="max-height: 200px; overflow-y: auto;">
                    {% for skill in results.jd_skills %}
                    <span class="skill-item">{{ skill }}</span>
                    {% endfor %}
                </div>
            </div>

            <div class="card" style="background: var(--bg-secondary);">
                <h4 style="margin-bottom: 1rem; color: var(--text-primary);">
                    <i class="fas fa-user"></i> Your Resume Skills
                </h4>
                <div style="max-height: 200px; overflow-y: auto;">
                    {% for skill in results.resume_skills %}
                    <span class="skill-item">{{ skill }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div style="text-align: center; margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
        <a href="{{ url_for('analyze_page') }}" class="btn" style="margin-right: 1rem;">
            <i class="fas fa-plus"></i> New Analysis
        </a>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-home"></i> Back to Dashboard
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Add subtle animation to the score circle
        const scoreCircle = document.querySelector('.score-circle');
        scoreCircle.style.animation = 'fadeIn 0.8s ease-out';
    });
</script>
{% endblock %}

<!-- Add this section to your existing analysis_detail.html template -->
{% if results.gap_bridge_plans %}
<div class="gap-bridge-section" style="margin-top: 30px; padding: 20px; background: #e8f5e9; border-radius: 8px;">
    <h2>ðŸš€ Personalized Learning Plans</h2>

    <div class="learning-summary" style="background: white; padding: 15px; border-radius: 5px; margin: 15px 0;">
        <h3>ðŸ“Š Learning Summary</h3>
        <p><strong>Total Skills to Learn:</strong> {{ results.gap_bridge_plans.summary.total_skills }}</p>
        <p><strong>Total Time Required:</strong> {{ results.gap_bridge_plans.summary.total_hours }} hours</p>
        <p><strong>Estimated Completion:</strong> {{ results.gap_bridge_plans.summary.total_weeks }} weeks
            ({{ results.gap_bridge_plans.summary.weekly_commitment }} hours/week)</p>
        <p><strong>Target Date:</strong> {{ results.gap_bridge_plans.summary.estimated_completion }}</p>
    </div>

    {% for plan in results.gap_bridge_plans.plans %}
    <div class="skill-plan"
        style="background: white; padding: 20px; margin: 20px 0; border-radius: 8px; border-left: 5px solid #2196F3;">
        <h3>{{ plan.skill }} - {{ plan.time_required }} hours</h3>
        <p>Complete in {{ plan.weeks_needed }} weeks ({{ plan.daily_recommendation }})</p>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
            <div>
                <h4>ðŸ“š Resources:</h4>
                {% for resource in plan.resources %}
                <div style="background: #f5f5f5; padding: 10px; margin: 5px 0; border-radius: 4px;">
                    <strong>{{ resource.name }}</strong><br>
                    {% if resource.url %}
                    <a href="{{ resource.url }}" target="_blank">Visit â†’</a><br>
                    {% endif %}
                    <small>Duration: {{ resource.duration_hours }} hours | Rating: {{ resource.rating }}/5.0</small>
                </div>
                {% endfor %}
            </div>

            <div>
                <h4>ðŸ’» Projects:</h4>
                {% for project in plan.projects %}
                <div style="background: #f5f5f5; padding: 10px; margin: 5px 0; border-radius: 4px;">
                    <strong>{{ project.title }}</strong><br>
                    <small>{{ project.description }}</small><br>
                    <small>Time: {{ project.estimated_time }}h | Difficulty: {{ project.complexity }}</small>
                </div>
                {% endfor %}
            </div>
        </div>

        <button class="save-plan-btn" data-skill="{{ plan.skill }}"
            style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; margin-top: 15px; cursor: pointer;">
            ðŸ’¾ Save This Plan
        </button>
    </div>
    {% endfor %}
</div>

<script>
    document.querySelectorAll('.save-plan-btn').forEach(button => {
        button.addEventListener('click', function () {
            const skill = this.getAttribute('data-skill');

            // Get resources and projects from this plan
            const planElement = this.closest('.skill-plan');
            const resources = Array.from(planElement.querySelectorAll('.resources div')).map(el => {
                return el.querySelector('strong').textContent;
            });
            const projects = Array.from(planElement.querySelectorAll('.projects div')).map(el => {
                return el.querySelector('strong').textContent;
            });

            fetch('/save-learning-plan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    skill_name: skill,
                    selected_resources: resources,
                    selected_projects: projects
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Learning plan saved! View it in "My Learning Plans"');
                    } else {
                        alert('Failed to save plan: ' + data.error);
                    }
                });
        });
    });
</script>
{% endif %}